"use strict";var express=require("express"),bcrypt=require("bcryptjs"),jwt=require("jsonwebtoken"),Users=require("../users/users-model"),restrict=require("../middleware/restrict"),router=express.Router();router.post("/register",function(r,t,s){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.body.username,e.next=4,regeneratorRuntime.awrap(Users.findBy({username:n}).first());case 4:if(e.sent)return e.abrupt("return",t.status(409).json({message:"Username is already taken"}));e.next=7;break;case 7:return e.t0=t.status(201),e.next=10,regeneratorRuntime.awrap(Users.add(r.body));case 10:e.t1=e.sent,e.t0.json.call(e.t0,e.t1),e.next=17;break;case 14:e.prev=14,e.t2=e.catch(0),s(e.t2);case 17:case"end":return e.stop()}},null,null,[[0,14]])}),router.post("/login",function(r,t,s){var n,a,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n={message:"Invalid Credentials"},e.prev=1,e.next=4,regeneratorRuntime.awrap(Users.findBy({username:r.body.username}).first());case 4:if(a=e.sent){e.next=7;break}return e.abrupt("return",t.status(401).json(n));case 7:return e.next=9,regeneratorRuntime.awrap(bcrypt.compare(r.body.password,a.password));case 9:if(e.sent){e.next=12;break}return e.abrupt("return",t.status(401).json(n));case 12:u={userId:a.id,userRole:"admin"},t.cookie("token",jwt.sign(u,process.env.JWT_SECRET)),t.json({message:"Welcome ".concat(a.username,"!")}),e.next=20;break;case 17:e.prev=17,e.t0=e.catch(1),s(e.t0);case 20:case"end":return e.stop()}},null,null,[[1,17]])}),router.get("/logout",function(e,r,t){e.session.destroy(function(e){e?t(e):r.json({message:"Successfully logged out"})})}),module.exports=router;